import { Plugin, Menu, Dialog, getFrontend } from "siyuan";
import { createApp } from 'vue'
import SettingView from './view/Setting.vue'

export default class PersonalLedgerPlug extends Plugin {

  private isMobile = getFrontend().endsWith('mobile');

  // 初始化顶栏的菜单
  initTopBarMenu = (rect: any) => {
    const menu = new Menu("pledgerTopbarMenu");
    menu.addItem({
      icon: "iconPlIcon",
      label: "打开账本",
      click: () => {
        console.log("打开账本");
      },
    });
    menu.addItem({
      icon: "iconSettings",
      label: "设置",
      click: () => {
        this.openSetting();
      },
    });
    if (this.isMobile) {
      menu.fullscreen();
    } else {
      var rectDom = document.querySelector("#barPlugins") || document.querySelector("#barMore")
      if (rect.width === 0 && rectDom) {
        rect = rectDom.getBoundingClientRect();
      }
      menu.open({
        x: rect.right,
        y: rect.bottom,
        isLeft: true
      });
    }
  }

  openSetting(): void {
    let dialog = new Dialog({
      title: "SettingPannel",
      content: `<div id="SettingPanel" style="height: 100%;"></div>`,
      width: "800px",
      destroyCallback: (options) => {
        console.log("destroyCallback", options);
        //You'd better destroy the component when the dialog is closed
        // pannel.$destroy();
        settingView.unmount()
      }
    });
    const settingView = createApp(SettingView)
    settingView.mount('#SettingPanel')
  }

  async onload() {
    // 注册图标, id 一定要为 icon 开头
    this.addIcons(`<symbol id="iconPlIcon" viewBox="0 0 1024 1024"><path d="M401.97233777 285.82798236a36.40888884 36.40888884 0 0 0-71.1429689 15.51018647c10.19448905 46.96746666 52.06471113 149.13080896 144.76174229 207.45784895V548.40888884H390.68558223a36.40888884 36.40888884 0 1 0 0 72.81777782H475.59111116V730.45333331a36.40888884 36.40888884 0 0 0 72.81777768 0V621.22666666h84.97834672a36.40888884 36.40888884 0 1 0 0-72.81777782H548.40888884v-39.61287106c92.69703122-58.32703997 134.56725313-160.49038222 144.83455998-207.53066681a36.40888884 36.40888884 0 0 0-71.14296883-15.43736861c-7.86431998 35.89916446-41.50613334 115.27054215-110.10047999 159.76220426-68.59434663-44.49166255-102.16334221-123.79022223-110.02766223-159.76220426z" fill="#333333" p-id="1390"></path><path d="M514.47580429 14.4361246h-4.95160879c-100.56135118 0-179.35018669 0-241.39093346 7.50023089-63.42428447 7.71868404-114.17827518 23.7385955-155.83004423 59.34648933-11.14111999 9.46631109-21.48124439 19.87925327-31.0203736 31.02037294-35.60789337 41.65176891-51.6278043 92.40575975-59.3464886 155.8300445-7.50023099 62.04074642-7.50023099 140.82958229-7.50023101 241.39093345v4.95160879c0 100.56135118 0 179.42300448 7.50023101 241.46375113 7.71868404 63.3514666 23.7385955 114.10545762 59.3464886 155.83004433 9.46631109 11.06830219 19.87925327 21.48124439 31.0203736 30.94755583 41.65176891 35.60789337 92.40575975 51.70062224 155.83004423 59.3464886 62.04074642 7.50023099 140.82958229 7.50023099 241.39093346 7.50023101h4.95160879c100.56135118 0 179.42300448 0 241.46375121-7.50023101 63.3514666-7.71868404 114.10545762-23.7385955 155.83004446-59.3464886 11.06830219-9.46631109 21.48124439-19.87925327 30.94755583-30.94755583 35.60789337-41.72458683 51.70062224-92.47857786 59.3464886-155.83004433 7.50023099-62.04074642 7.50023099-140.90240001 7.50023101-241.46375113v-4.95160879c0-100.56135118 0-179.35018669-7.50023101-241.39093345-7.71868404-63.42428447-23.7385955-114.17827518-59.3464886-155.83004445a279.11054223 279.11054223 0 0 0-30.94755583-31.02037299c-41.72458683-35.60789337-92.47857786-51.6278043-155.83004446-59.34648933-62.04074642-7.50023099-140.90240001-7.50023099-241.463751-7.50023089zM159.56195531 136.69717333c26.36003555-22.57351097 61.0212977-35.68071124 117.30944051-42.4527646 57.16195557-6.91768907 131.5817246-6.99050698 235.20142171-6.99050662 103.54687999 0 177.89383133 0 235.05578695 6.99050662 56.2881422 6.84487134 90.94940439 19.87925327 117.30943973 42.4527646 8.22840894 6.99050698 15.87427562 14.63637307 22.93760028 22.86478246 22.57351097 26.36003555 35.5350754 61.0212977 42.37994651 117.30943973 6.99050698 57.16195557 6.99050698 131.5817246 6.99050689 235.20142243 0 103.54687999 0 177.89383133-6.99050689 235.05578653-6.84487134 56.2881422-19.87925327 90.94940439-42.37994651 117.30943973a205.92867554 205.92867554 0 0 1-22.93760028 22.93760028c-26.36003555 22.57351097-61.0212977 35.5350754-117.30943973 42.37994651-57.16195557 6.99050698-131.50890668 6.99050698-235.12860448 6.99050689-103.54687999 0-177.9666489 0-235.12860418-6.99050689-56.2881422-6.84487134-90.94940439-19.87925327-117.30944003-42.37994651a206.07431118 206.07431118 0 0 1-22.86478246-22.9375998c-22.57351097-26.36003555-35.68071124-61.0212977-42.4527646-117.30944051-6.91768907-57.16195557-6.99050698-131.50890668-6.99050637-235.12860418 0-103.54687999 0-177.9666489 6.99050637-235.12860448 6.84487134-56.2881422 19.87925327-90.94940439 42.4527646-117.30943973 6.99050698-8.22840894 14.63637307-15.87427562 22.86478246-22.86478246z"></path></symbol>`);
    // 将该实例注册到全局
    window.PersonalLedgerPlugHandler = this

    const frontEnd = getFrontend();
    this.isMobile = frontEnd === "mobile" || frontEnd === "browser-mobile";

    // 注册顶栏
    const topBarElement = this.addTopBar({
      icon: "iconPlIcon", // 图标
      title: "pledger 账本", // 鼠标悬停时显示的标题
      position: "right",
      callback: () => {
        let rect = topBarElement.getBoundingClientRect();
        this.initTopBarMenu(rect);
      },
    });
  }

  async onLayoutReady() {
    //布局加载完成的时候，会自动调用这个函数
  }

  async onunload() {
    //当插件被禁用的时候，会自动调用这个函数
  }

  async uninstall() {
    //当插件被卸载的时候，会自动调用这个函数
  }




};

import "./utils/safe-custom-elements-patch ";
import "cally";
import {
  Plugin,
  Menu,
  Dialog,
  getFrontend,
  openTab,
  showMessage,
  openMobileFileById,
} from "siyuan";
import { createApp, ref } from "vue";

import { open } from "./utils/dialog-utils";

import SettingView from "./view/Setting.vue";
import MainView from "./view/pc/PCMain.vue";
import MobileView from "./view/mobile/MobileMain.vue";
import "./index.css";

const settingConfFile = "setting.json"; // 插件的数据，会被保存在 data/storage/petal/<name>/​ 下
const settingConfData = ref<SettingConfig>({
  documentId: "",
  config: "",
  planNum: "",
});

const icons = [
  `<symbol id="iconD3PlIcon" viewBox="0 0 1024 1024"><path d="M401.97233777 285.82798236a36.40888884 36.40888884 0 0 0-71.1429689 15.51018647c10.19448905 46.96746666 52.06471113 149.13080896 144.76174229 207.45784895V548.40888884H390.68558223a36.40888884 36.40888884 0 1 0 0 72.81777782H475.59111116V730.45333331a36.40888884 36.40888884 0 0 0 72.81777768 0V621.22666666h84.97834672a36.40888884 36.40888884 0 1 0 0-72.81777782H548.40888884v-39.61287106c92.69703122-58.32703997 134.56725313-160.49038222 144.83455998-207.53066681a36.40888884 36.40888884 0 0 0-71.14296883-15.43736861c-7.86431998 35.89916446-41.50613334 115.27054215-110.10047999 159.76220426-68.59434663-44.49166255-102.16334221-123.79022223-110.02766223-159.76220426z"></path><path d="M514.47580429 14.4361246h-4.95160879c-100.56135118 0-179.35018669 0-241.39093346 7.50023089-63.42428447 7.71868404-114.17827518 23.7385955-155.83004423 59.34648933-11.14111999 9.46631109-21.48124439 19.87925327-31.0203736 31.02037294-35.60789337 41.65176891-51.6278043 92.40575975-59.3464886 155.8300445-7.50023099 62.04074642-7.50023099 140.82958229-7.50023101 241.39093345v4.95160879c0 100.56135118 0 179.42300448 7.50023101 241.46375113 7.71868404 63.3514666 23.7385955 114.10545762 59.3464886 155.83004433 9.46631109 11.06830219 19.87925327 21.48124439 31.0203736 30.94755583 41.65176891 35.60789337 92.40575975 51.70062224 155.83004423 59.3464886 62.04074642 7.50023099 140.82958229 7.50023099 241.39093346 7.50023101h4.95160879c100.56135118 0 179.42300448 0 241.46375121-7.50023101 63.3514666-7.71868404 114.10545762-23.7385955 155.83004446-59.3464886 11.06830219-9.46631109 21.48124439-19.87925327 30.94755583-30.94755583 35.60789337-41.72458683 51.70062224-92.47857786 59.3464886-155.83004433 7.50023099-62.04074642 7.50023099-140.90240001 7.50023101-241.46375113v-4.95160879c0-100.56135118 0-179.35018669-7.50023101-241.39093345-7.71868404-63.42428447-23.7385955-114.17827518-59.3464886-155.83004445a279.11054223 279.11054223 0 0 0-30.94755583-31.02037299c-41.72458683-35.60789337-92.47857786-51.6278043-155.83004446-59.34648933-62.04074642-7.50023099-140.90240001-7.50023099-241.463751-7.50023089zM159.56195531 136.69717333c26.36003555-22.57351097 61.0212977-35.68071124 117.30944051-42.4527646 57.16195557-6.91768907 131.5817246-6.99050698 235.20142171-6.99050662 103.54687999 0 177.89383133 0 235.05578695 6.99050662 56.2881422 6.84487134 90.94940439 19.87925327 117.30943973 42.4527646 8.22840894 6.99050698 15.87427562 14.63637307 22.93760028 22.86478246 22.57351097 26.36003555 35.5350754 61.0212977 42.37994651 117.30943973 6.99050698 57.16195557 6.99050698 131.5817246 6.99050689 235.20142243 0 103.54687999 0 177.89383133-6.99050689 235.05578653-6.84487134 56.2881422-19.87925327 90.94940439-42.37994651 117.30943973a205.92867554 205.92867554 0 0 1-22.93760028 22.93760028c-26.36003555 22.57351097-61.0212977 35.5350754-117.30943973 42.37994651-57.16195557 6.99050698-131.50890668 6.99050698-235.12860448 6.99050689-103.54687999 0-177.9666489 0-235.12860418-6.99050689-56.2881422-6.84487134-90.94940439-19.87925327-117.30944003-42.37994651a206.07431118 206.07431118 0 0 1-22.86478246-22.9375998c-22.57351097-26.36003555-35.68071124-61.0212977-42.4527646-117.30944051-6.91768907-57.16195557-6.99050698-131.50890668-6.99050637-235.12860418 0-103.54687999 0-177.9666489 6.99050637-235.12860448 6.84487134-56.2881422 19.87925327-90.94940439 42.4527646-117.30943973 6.99050698-8.22840894 14.63637307-15.87427562 22.86478246-22.86478246z"></path></symbol>`,
  `<symbol id="iconD3TimeIcon" viewBox="0 0 1024 1024"><path d="M512 926.25224691c-228.41868895 0-414.25224691-185.83355796-414.25224691-414.25224691S283.58131105 97.74775309 512 97.74775309s414.25224691 185.83355796 414.25224691 414.25224691-185.83355796 414.25224691-414.25224691 414.25224691m0-911.35494321C237.88928821 14.8973037 14.8973037 237.88928821 14.8973037 512s222.99198451 497.1026963 497.1026963 497.1026963 497.1026963-222.99198451 497.1026963-497.1026963S786.11071179 14.8973037 512 14.8973037" p-id="1421"></path><path d="M553.42522469 504.04635685V263.44865185a41.42522469 41.42522469 0 0 0-82.85044938 0v257.74774803c0 10.97768453 4.34964859 21.54111683 12.13759082 29.28763386l138.8987784 138.89877839a41.30094901 41.30094901 0 0 0 58.57526772 0 41.42522469 41.42522469 0 0 0 0-58.57526771L553.42522469 504.04635685z"></path></symbol>`,
  `<symbol id="iconD3EidtIcon" viewBox="0 0 1061 1024" ><path d="M854.856875 477.7146875v377.143125c0 37.87125001-30.7003125 68.5715625-68.5715625 68.5715625H169.1421875c-37.87125001 0-68.5715625-30.7003125-68.5715625-68.5715625V237.7146875c0-37.87125001 30.7003125-68.5715625 68.5715625-68.5715625h411.4284375V100.5715625H169.1421875C93.400625 100.5715625 31.9990625 161.9721875 31.9990625 237.7146875v617.143125c0 75.7415625 61.400625 137.143125 137.143125 137.143125h617.143125c75.7415625 0 137.143125-61.400625 137.143125-137.143125V477.7146875h-68.5715625z"></path><path d="M405.0284375 757.8284375c-4.8234375 0.76124999-10.3865625 1.1953125-16.0509375 1.19531251-25.36124999 0-48.688125-8.7140625-67.1475-23.31187501-22.74375001-22.798125-22.0584375-55.7128125-21.373125-109.8834375 2.6728125-42.421875 20.05875001-80.3353125 47.0596875-109.123125L810.9715625 53.256875c38.4-38.4 93.943125-19.2 129.6 15.0853125 10.2853125 10.2853125 38.056875 38.4 48.343125 48.343125 34.2853125 34.2853125 55.2 90.856875 16.1146875 130.2853125L541.1440625 710.8559375c-28.3171875 27.7434375-66.643125 45.3665625-109.0696875 46.9621875l-27.045 0.009375z m-34.2853125-70.6284375c12.553125 1.6284375 27.07124999 2.5584375 41.8078125 2.5584375 6.5203125 0 12.9975-0.181875 19.42781249-0.5409375 23.13374999-1.54124999 44.5865625-11.4309375 60.87281251-26.750625l464.863125-463.8375c0.00374999-0.22125001 0.0065625-0.481875 0.00656249-0.7434375 0-13.4625-6.1096875-25.498125-15.70687499-33.48468749-10.3565625-10.0003125-38.8134375-38.4571875-48.7565625-48.7425-8.278125-9.4771875-20.385-15.4303125-33.8821875-15.43031251l-0.425625 0.001875-463.5215625 463.543125a108.4565625 108.4565625 0 0 0-26.7140625 62.330625c-0.3740625 6.1021875-0.5709375 12.7546875-0.5709375 19.453125 0 14.6803125 0.9440625 29.139375 2.7759375 43.3209375z"></path></symbol>`,
  `<symbol id="iconD3FluIcon" viewBox="0 0 1024 1024"><path d="M648.53333333 921.6a34.13333333 34.13333333 0 0 1-32.08533333-23.21066667L375.46666667 176.128 271.01866667 488.78933333A34.13333333 34.13333333 0 0 1 238.93333333 512H34.13333333a34.13333333 34.13333333 0 0 1 0-68.26666667h180.224l129.024-386.38933333a35.49866667 35.49866667 0 0 1 64.85333334 0L648.53333333 779.60533333l104.448-312.66133333A34.13333333 34.13333333 0 0 1 785.06666667 443.73333333h204.8a34.13333333 34.13333333 0 0 1 0 68.26666667h-180.224l-129.024 386.38933333A34.13333333 34.13333333 0 0 1 648.53333333 921.6z"></path></symbol>`,
  `<symbol id="iconD3List" viewBox="0 0 1024 1024"><path d="M106.28234686 66.39962635c-41.41551536 0-74.97989678 33.58849863-74.98441856 75.03717184 0 41.44716643 33.56890469 75.03566508 74.98441856 75.03566505 41.41250034 0 74.97688322-33.58849863 74.97688323-75.03566505C181.25922862 99.98812351 147.6948472 66.39962635 106.28234686 66.39962635z"></path><path d="M961.0579994 96.41148065L331.22505367 96.41148065c-16.58248431 0-29.99376714 13.43992036-29.99226036 30.01486932l0 30.01185432c0 16.57494749 13.41128431 30.01939111 29.99226036 30.01939111l629.83294722 0c16.58097605 0 29.99376714-13.44444217 29.99376713-30.01939111l0-30.01185432C991.05176802 109.85140101 977.63897694 96.41148065 961.0579994 96.41148065z" ></path><path d="M106.28234686 436.96584318c-41.41551536 0-74.97989678 33.58849863-74.98441856 75.04169363 0 41.44264464 33.56890469 75.02662148 74.98441856 75.02662148 41.41250034 0 74.97688322-33.58397684 74.97688323-75.02662148C181.25922862 470.55434034 147.6948472 436.96584318 106.28234686 436.96584318z" ></path><path d="M961.0579994 466.97618924L331.22505367 466.97618924c-16.58248431 0-29.99376714 13.44595041-29.99226036 30.01637608l0 30.01486936c0 16.59454144 13.41128431 30.02089789 29.99226036 30.02089787l629.83294722 0c16.58097605 0 29.99376714-13.42786323 29.99376713-30.02089787l0-30.01486936C991.05176802 480.42063286 977.63897694 466.97618924 961.0579994 466.97618924z"></path><path d="M106.28234686 807.52753821c-41.41551536 0-74.98441855 33.59302043-74.98441856 75.03566508 0 41.44716643 33.56890469 75.03566508 74.98441856 75.03566506 41.41250034 0 74.97688322-33.58849863 74.97688323-75.03566506C181.25922862 841.12055718 147.6948472 807.52753821 106.28234686 807.52753821z"></path><path d="M961.0579994 837.54240607L331.22505367 837.54240607c-16.58248431 0-29.99376714 13.42786323-29.99226036 30.0163761l0 30.01486933c0 16.59454144 13.41128431 30.0163761 29.99226036 30.01637609l629.83294722 0c16.58097605 0 29.99376714-13.42334143 29.99376713-30.01637609l0-30.01486933C991.05176802 850.96876254 977.63897694 837.54240607 961.0579994 837.54240607z"></path></svg>`,
  `<symbol id="iconD3DB" viewBox="0 0 1024 1024" ><path d="M512 38.68444445C267.00458667 38.68444445 75.09333333 150.64177778 75.09333333 293.54666667v436.90666666c0 142.90488889 191.91125333 254.86222222 436.90666667 254.86222222s436.90666667-111.95733333 436.90666667-254.86222222V293.54666667c0-142.90488889-191.91125333-254.86222222-436.90666667-254.86222222z m364.08888889 473.31555555c0 43.79989333-35.86275555 88.43719111-98.34040889 122.51591111C707.37009778 672.89088 612.99825778 694.04444445 512 694.04444445s-195.37009778-21.15356445-265.74848-59.52853334C183.77386667 600.43719111 147.91111111 555.79989333 147.91111111 512v-75.73048889C225.57127111 504.53617778 358.31808 548.40888889 512 548.40888889s286.42872889-44.05475555 364.08888889-112.13937778V512zM246.25152 171.03075555C316.62990222 132.65578667 411.00174222 111.50222222 512 111.50222222s195.37009778 21.15356445 265.74848 59.52853333C840.22613333 205.10947555 876.08888889 249.74677333 876.08888889 293.54666667c0 43.79989333-35.86275555 88.43719111-98.34040889 122.51591111C707.37009778 454.43754667 612.99825778 475.59111111 512 475.59111111s-195.37009778-21.15356445-265.74848-59.52853333C183.77386667 381.98385778 147.91111111 337.34656 147.91111111 293.54666667c0-43.79989333 35.86275555-88.43719111 98.34040889-122.51591112zM777.78488889 852.96924445C707.37009778 891.34421333 612.99825778 912.49777778 512 912.49777778s-195.37009778-21.15356445-265.74848-59.52853333C183.77386667 818.89052445 147.91111111 774.25322667 147.91111111 730.45333333v-75.73048888C225.57127111 722.98951111 358.31808 766.86222222 512 766.86222222s286.42872889-44.05475555 364.08888889-112.13937777V730.45333333c0 43.79989333-35.86275555 88.43719111-98.34040889 122.51591112z" ></path></svg>`,
  // AI 图标
  `<symbol id="iconD3AI" viewBox="0 0 1024 1024"><path d="M204.8 29.99182187c152.73528853-8.92017813 404.22968853-9.51182187 515.82293333 0.04551146 81.1008 4.55111147 166.34311147 59.93813333 179.04071147 169.1648 9.51182187 81.6924448 11.92391147 190.41848853 11.24124373 255.4083552l-0.09102186 8.7836448v2.77617814a34.13333333 34.13333333 0 1 1-68.26666667 0v-3.2768c0-2.00248853 0-4.7331552 0.09102187-9.0112 0.6371552-62.35022187-1.6384-168.3456-10.78613334-246.80675627-8.14648853-70.08711147-63.39697813-105.99537813-116.05333333-108.9536-108.90808853-9.28426667-357.26222187-8.73813333-507.03928853 0-72.81777813 4.23253333-117.23662187 80.23608853-117.23662187 152.91733333-0.2275552 19.38773333-0.4096 41.32408853-0.45511147 72.22613334v139.4460448l0.2275552 91.1132448v24.576l0.04551147 4.5056v16.65706666l0.04551147 8.05546667v17.52177707l0.09102186 32.63146666v29.8552896l0.04551147 14.10844374v39.86773333c0 128.88746667 52.11022187 177.03822187 130.11626667 182.6360896a8528.19057813 8528.19057813 0 0 0 184.09244373 9.6483552 34.13333333 34.13333333 0 0 1-2.13902187 68.26666667 3686.03591147 3686.03591147 0 0 1-100.03342186-4.6876448 10534.82097813 10534.82097813 0 0 1-86.56213334-5.1427552c-111.95733333-8.0099552-193.7408-83.60391147-193.7408-250.76622187v-39.77671147-14.1084448l-0.04551146-29.80977706-0.09102187-50.10773334v-8.05546666l-0.04551147-18.88711147v-2.2755552l-0.04551146-20.34346667v-4.23253333l-0.18204374-91.3408v-25.71377813l-0.04551146-12.01493334V322.90133333c0.04551147-30.9475552 0.2275552-52.88391147 0.45511146-72.36266666 0-103.8108448 64.17066667-213.72017813 181.54382187-220.5468448z m531.38773333 600.29155626l107.40622187 256.8192a34.13333333 34.13333333 0 0 1-62.98737707 26.35093334l-20.8440896-49.83466667h-124.06328853l-51.6096 106.35946667a34.13333333 34.13333333 0 0 1-41.32408853 17.56728853l-4.32355627-1.77493333a34.13333333 34.13333333 0 0 1-15.7923552-45.60213334l151.3244448-311.61457813a34.13333333 34.13333333 0 0 1 62.21368853 1.72942293z m151.64302187 0l107.04213333 256.0455104a34.13333333 34.13333333 0 1 1-62.98737706 26.35093334l-107.04213334-256.0455104a34.13333333 34.13333333 0 0 1 62.98737707-26.35093334z m-185.50328853 96.0739552l-33.49617814 68.9948448h62.35022294l-28.8540448-68.9948448z m-236.7488-294.63893333a34.13333333 34.13333333 0 1 1 0 68.26666667h-182.0444448a34.13333333 34.13333333 0 0 1 0-68.26666667h182.0444448z m182.0444448-182.0444448a34.13333333 34.13333333 0 1 1 0 68.26666667h-364.0888896a34.13333333 34.13333333 0 0 1 0-68.26666667h364.0888896z"></path></svg>`,
  // 支付宝
  `<symbol id="iconAlipayIcon" viewBox="0 0 1024 1024"><path d="M1024.0512 701.0304V196.864A196.9664 196.9664 0 0 0 827.136 0H196.864A196.9664 196.9664 0 0 0 0 196.864v630.272A196.9152 196.9152 0 0 0 196.864 1024h630.272a197.12 197.12 0 0 0 193.8432-162.0992c-52.224-22.6304-278.528-120.32-396.4416-176.64-89.7024 108.6976-183.7056 173.9264-325.3248 173.9264s-236.1856-87.2448-224.8192-194.048c7.4752-70.0416 55.552-184.576 264.2944-164.9664 110.08 10.3424 160.4096 30.8736 250.1632 60.5184 23.1936-42.5984 42.496-89.4464 57.1392-139.264H248.064v-39.424h196.9152V311.1424H204.8V267.776h240.128V165.632s2.1504-15.9744 19.8144-15.9744h98.4576V267.776h256v43.4176h-256V381.952h208.8448a805.9904 805.9904 0 0 1-84.8384 212.6848c60.672 22.016 336.7936 106.3936 336.7936 106.3936zM283.5456 791.6032c-149.6576 0-173.312-94.464-165.376-133.9392 7.8336-39.3216 51.2-90.624 134.4-90.624 95.5904 0 181.248 24.4736 284.0576 74.5472-72.192 94.0032-160.9216 150.016-253.0816 150.016z"></path></symbol>`,
  // 微信
  `<symbol id="iconWeChatIcon" viewBox="0 0 1076 1024"><path d="M416.837855 608.34532854c-60.42044156 34.66599375-69.38145094-19.46246063-69.38145094-19.46246063l-75.72391218-181.85993717c-29.13615188-86.41716094 25.21640343-38.96429062 25.21640437-38.96428969s46.63722377 36.31141969 82.03305937 58.437855c35.37463687 22.127445 75.69867469 6.49488938 75.69867562 6.49488938l495.04100907-235.16466845C858.38738188 80.86318386 707.51293344 4.38318354 536.705615 4.38318354 257.95028375 4.38318354 32 207.91327853 32 458.99517075c0 144.41892749 74.81842313 272.95697156 191.35798125 356.2680131L202.34195561 939.60084917s-10.24504688 36.300315 25.26183001 19.46246062c24.19583625-11.47861219 85.87810687-52.61526843 122.59533095-77.65097811 57.722145 20.70309187 120.61072594 32.19886406 186.53476312 32.19886406 278.73312281 0 504.72984188-203.53009499 504.7298428-454.61703469 0-72.7247953-19.04353311-141.4066875-52.7767828-202.37022003-157.72164 97.665615-524.57388 324.639495-571.85009439 351.71936909z"></path></symbol>`,
  // 建行
  `<symbol id="iconCBCBankIcon" viewBox="0 0 1024 1024"><path d="M660.49942659 108.22986971c-71.76739085-81.69668065-139.01004397-82.19942896-139.01004248-82.19942897s161.19383433-69.75639613 306.36255061 75.41232013l153.96681982 153.96681982s10.49488074 8.98663434 9.42654001 14.32834084c-2.2623696 10.49488074-8.29535522 21.24113634-8.29535521 21.24113635l-70.51051934 67.55687062-252.00283601-250.30605879z m302.65477871 434.87771236s13.13431194-2.95364871 19.48151653 1.57109048c6.09582971 4.39905249 5.2788624 6.66142211 5.21601831 9.74075753-11.94028452 256.2762018-223.84890414 460.32937041-477.61136143 460.32937042-257.47022922 0-477.54851734-212.59989873-477.54851736-478.05126565 0-235.97771797 167.28966401-433.87221574 398.1770504-471.89259334 25.89156372-4.21052172 92.75715378-9.74075754 153.65260231 51.09184692l287.44662793 286.00122414-98.66445267 100.1726991s-13.95127923 12.44303282-23.62919415 9.92928833c-10.43203811-2.76511791-19.16729755-12.94578113-19.16729754-12.94578113l-213.54255273-213.66824092a9.67791491 9.67791491 0 0 0-13.57421761 0L260.62559901 527.58521234a9.67791491 9.67791491 0 0 0 0 13.63706172l242.38776665 241.75933016c3.770616 3.770616 9.80360162 3.770616 13.57421765 0l228.24795514-227.17961445s10.49488074-8.79810353 14.20265414-10.4320381c5.65592402-2.57658711 18.97876674-2.2623696 18.97876674-2.2623696h185.07440188z"></path></symbol>`,
  // 中信
  `<symbol id="iconCITICBankIcon" viewBox="0 0 1024 1024"><path d="M310.3712 121.6688c77.4576 29.5104 147.5376 103.2672 147.5376 190.5408l1.2096 671.3088c17.2368 2.472 35.664 3.6816 54.1056 3.6816 19.6704 0 38.0976-1.2096 56.5392-3.6816V312.2096c0-87.2784 70.0848-161.0304 146.3136-190.5408 8.5968-2.4816 13.5024-11.1024 13.5024-19.704s-6.12-17.1744-14.7216-20.8896C653.3936 52.8032 585.7424 36.8 513.2288 36.8 441.9152 36.8 374.288 52.8032 312.824 81.0752c-8.6208 3.7104-14.7504 12.288-14.7504 20.8896s4.9056 17.2224 12.2976 19.704"></path><path d="M389.0384 969.9968V355.2752c0-67.6608-38.1024-124.2192-90.9648-146.3664v726.6288c28.2768 14.7792 59.016 25.8624 90.9648 34.4592M729.5888 935.5328V208.904c-52.8384 22.1472-90.936 78.7056-90.936 146.3664v614.7216c31.9392-8.592 62.6784-19.6752 90.936-34.4592M136.9856 426.5552c3.7104 0 7.3824 3.6816 8.616 7.392 7.368 28.2432 29.5056 47.9472 56.5536 50.3952 8.616-1.272 15.9744-4.8912 22.1376-11.0736V135.152C112.4 221.2208 38.6384 357.7136 38.6384 511.352c0 153.7296 73.7616 290.1552 185.6592 377.5008v-339.36c-6.1632-6.1488-13.5216-9.84-22.1376-9.84-27.048 1.272-49.1856 22.1856-56.5536 49.1952-1.2336 3.648-4.9008 7.3584-8.616 7.3584-3.6528 0-6.12-3.7104-7.368-4.9104-17.2176-20.8944-27.0336-49.1952-27.0336-79.944 0-30.6672 9.816-58.9968 27.0336-79.8864 1.2432-1.2288 3.7104-4.9104 7.3632-4.9104M954.6224 539.6576c-27.048 1.2384-49.2144 22.1856-57.7968 49.1952-1.2384 3.648-3.7104 7.3584-7.3632 7.3584-3.7008 0-7.3584-3.7104-7.3584-4.9104-17.256-20.8944-28.3008-49.1952-28.3008-79.944 0-30.6912 11.0448-58.968 28.3008-79.8864 0-1.2336 3.6624-4.9104 7.3584-4.9104 3.6528 0 6.1248 3.6816 7.3632 7.4256 8.5824 28.2096 30.7488 47.9136 57.7968 50.3616 13.5264-1.2096 24.5712-11.0736 30.7392-23.3232-13.5216-131.616-81.1536-247.1664-179.5248-324.6336v749.9856c93.432-73.752 159.8352-181.9776 177.072-304.9248 1.2096-7.3536 2.4576-13.5072 2.4576-18.4608-6.1728-13.4928-17.2176-23.3328-30.744-23.3328"></path></symbol>`,
  // 邮储
  `<symbol id="iconPSBCBankIcon" viewBox="0 0 1092 1024"><path d="M100.215467 572.757333l-5.3248 30.037334h158.3104l7.031466-30.037334H100.215467z m402.773333 30.037334l5.256533-30.037334H328.9088l-7.099733 30.037334h181.111466z m100.283733-151.552l-24.712533 121.514666-6.9632 30.037334-24.644267 121.719466H297.1648l-5.256533 28.125867h291.976533L622.592 572.757333l24.644267-121.514666h350.071466l-26.350933 121.514666h-279.688533l-63.351467 301.397334H265.557333l-5.3248 28.2624h406.3232l38.7072-177.9712 24.576-121.787734h235.7248l-24.576 121.787734h-167.185066l-36.864 177.9712L710.656 1024H165.341867l63.2832-299.554133H0l26.350933-121.787734 5.188267-29.969066 26.4192-121.514667h226.850133l63.419734-299.690667H598.016L629.623467 0H1092.266667l-26.350934 121.6512H671.880533l-5.3248 29.9008-24.576 121.719467H392.192l-7.099733 28.125866h293.751466l5.3248-28.125866 26.350934-121.719467h350.0032l-26.350934 121.719467h-279.620266l-31.744 149.777066H360.584533l-7.099733 28.125867h249.787733z"></path></symbol>`,
  // 交通
  `<symbol id="iconBOCOMIcon" viewBox="0 0 1024 1024" version="1.1"><path d="M809.896714 767.843946c-60.409858 1.876744-116.209722 3.827165-176.563298 5.782703-38.184671 161.779593-354.464057 118.091582-319.257208-87.230714 17.73185-121.601522 183.015244-174.74693 285.479917-82.82845 22.548552 25.245987 33.55421 48.759517 40.856523 100.342336 50.608631-2.028193 118.884644-3.982708 169.484066-5.860475 2.597151-261.585717-296.151977-394.455887-520.178263-267.373537C74.975599 552.280402 99.804077 923.05289 324.767711 1017.787508l0 5.865591C202.067158 1021.222747 67.511603 926.663114 38.159088 814.348096l1.720178-603.25333c97.326653-65.840544 204.971301-144.859225 302.498522-210.747865 3.809769 2.000564 7.693216 3.866051 11.620665 5.866614-6.67605 90.856287-2.441609 240.748133 2.989077 350.252129 60.977793-58.934251 102.157681-120.555703 207.523427-140.997268 67.884087-13.161764 132.802632-5.190209 173.818791 8.682753 307.866786 104.923678 327.040475 500.552274 65.834404 636.69907-5.877871 0-18.710131 11.497868-28.196179 13.352099 0-1.949398 5.966898-10.380418 10.759041-19.134803C794.415115 825.984111 802.213731 796.916075 809.896714 767.843946L809.896714 767.843946 809.896714 767.843946zM809.896714 767.843946"></path></symbol>`,
];

export default class PersonalLedgerPlug extends Plugin {
  private isMobile = getFrontend().endsWith("mobile");

  // 初始化顶栏的菜单
  initTopBarMenu = (rect: any) => {
    const menu = new Menu("pledgerTopbarMenu");

    menu.addItem({
      icon: "iconD3PlIcon",
      label: "打开账本",
      click: () => {
        if (settingConfData.value.documentId) {
          this.openTab();
        } else {
          showMessage("pLedger<br>请先在设置中配置数据存放位置", 3000, "error");
          this.openSetting();
        }
      },
    });

    menu.addItem({
      icon: "iconSettings",
      label: "设置",
      click: () => {
        this.openSetting();
      },
    });

    if (this.isMobile) {
      menu.fullscreen();
    } else {
      var rectDom =
        document.querySelector("#barPlugins") ||
        document.querySelector("#barMore");
      if (rect.width === 0 && rectDom) {
        rect = rectDom.getBoundingClientRect();
      }
      menu.open({
        x: rect.right,
        y: rect.bottom,
        isLeft: true,
      });
    }
  };

  // 加载设置面板
  openSetting(): void {
    let dialog = new Dialog({
      title: "pLedger 插件设置",
      content: `<div id="SettingPanel" style="height: 100%;"></div>`,
      width: "800px",
      destroyCallback: () => {
        settingView.unmount();
      },
    });

    function closeSetting() {
      dialog.destroy();
    }

    function saveSetting(settingData: SettingConfig) {
      if (checkSettingConf(settingData)) {
        window.PersonalLedgerPlugHandler.saveData(settingConfFile, settingData);
        settingConfData.value = settingData;
        showMessage("设置已保存", 2000, "info");
        closeSetting();
      }
    }

    const settingView = createApp(SettingView, {
      closeSetting,
      saveSetting,
      settingConfData: settingConfData.value,
    });

    settingView.mount("#SettingPanel");
  }

  // 打开 tab
  openTab(): void {
    if (this.isMobile) {
      // 移动端弹窗打开
      const mainView = open(MobileView, {
        title: "pLedger",
        props: {
          settingConfData: settingConfData.value,
        },
      });
    } else {
      const id = "pLedgerPluginTab";
      this.addTab({
        type: id,
        init() {
          const mainView = createApp(MainView, {
            settingConfData: settingConfData.value,
          });
          mainView.mount(this.element);
        },
      });
      // 桌面端新标签页打开
      openTab({
        app: this.app,
        custom: {
          title: "pLedger",
          icon: "iconD3PlIcon",
          id: this.name + id,
        },
      });
    }
  }

  // 初始化插件
  async onload() {
    // 注册图标, id 一定要为 icon 开头
    icons.forEach((icon) => {
      this.addIcons(icon);
    });

    // 将该实例注册到全局
    window.PersonalLedgerPlugHandler = this;

    const frontEnd = getFrontend();
    this.isMobile = frontEnd === "mobile" || frontEnd === "browser-mobile";

    // 读取插件设置
    settingConfData.value = await this.loadData(settingConfFile);

    // 注册顶栏
    const topBarElement = this.addTopBar({
      icon: "iconD3PlIcon", // 图标
      title: "pledger 账本", // 鼠标悬停时显示的标题
      position: "right",
      callback: () => {
        let rect = topBarElement.getBoundingClientRect();
        this.initTopBarMenu(rect);
      },
    });
  }

  async onLayoutReady() {
    //布局加载完成的时候，会自动调用这个函数
  }

  async onunload() {
    //当插件被禁用的时候，会自动调用这个函数
  }

  async uninstall() {
    //当插件被卸载的时候，会自动调用这个函数
  }
}

function checkSettingConf(data: any): boolean {
  if (!data) {
    return false;
  }

  return true;
}
